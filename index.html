<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Offline ‚Äì Produtos Perdidos e Achados v5.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #f4f6f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --border: #334155;
      --shadow: 0 6px 18px rgba(0,0,0,.4);
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
    }

    header {
      background: linear-gradient(90deg, #1f2937, #111827);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { margin: 0; font-size: 20px; }

    .toggle-theme {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
    }

    .container { padding: 24px; max-width: 1400px; margin: auto; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      transition: transform .2s;
    }

    .card:hover { transform: translateY(-4px); }

    .card h3 { margin: 0; font-size: 13px; color: var(--muted); }
    .card p { font-size: 28px; margin: 8px 0 0; font-weight: bold; }

    .negativo { color: var(--danger); }
    .positivo { color: var(--success); }

    .box {
      background: var(--card);
      padding: 22px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      margin-top: 24px;
    }

    input, button {
      padding: 10px;
      margin-top: 6px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    input { background: var(--bg); }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
    }

    button:hover { opacity: .9; transform: scale(1.01); }

    button.green { background: var(--success); }
    button.red { background: var(--danger); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      table-layout: fixed;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      text-align: center;
    }

    th { background: rgba(0,0,0,.03); color: var(--muted); }

    tbody tr:hover { background: rgba(0,0,0,.04); }
  
 

@media (max-width: 768px) {

  table {
    table-layout: auto;
  }

  table thead {
    display: none;
  }

  table,
  tbody,
  tr,
  td {
    display: block;
    width: 100%;
    max-width: 100%;
  }

  table tr {
    background: var(--card);
    margin-bottom: 14px;
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 12px;
    box-sizing: border-box;
  }

  table td {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
    padding: 6px 0;
    border: none;
    font-size: 14px;
    word-break: break-word;
  }

  table td::before {
    content: attr(data-label);
    flex: 0 0 auto;
    font-weight: 600;
    color: var(--muted);
  }

  table td span,
  table td div {
    max-width: 100%;
  }

  /* ===== A√á√ïES ===== */
  table td[data-label="A√ß√µes"] {
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }

  table td[data-label="A√ß√µes"]::before {
    margin-bottom: 4px;
  }

  table td[data-label="A√ß√µes"] button {
    width: 100%;
    min-width: 0;
    padding: 12px;
    font-size: 14px;
    white-space: normal;
    line-height: 1.2;
  }
}

body {
  overflow-x: hidden;
}

@media (max-width: 768px) {

  .container {
    padding: 16px 12px;
  }

  table tr {
    margin-left: 2px;
    margin-right: 2px;
  }

  table td {
    overflow-wrap: anywhere;
  }

}



</style>
</head>
<body>
 

/* senha */ 

<div id="loginScreen" style="
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #1f2937, #111827);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">

  <div style="
    background: #fff;
    padding: 32px;
    border-radius: 16px;
    width: 320px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,.3);
  ">
    <h2 style="margin-bottom: 16px;">üîê Acesso ao Sistema</h2>

    <input 
      type="password" 
      id="senhaInput" 
      placeholder="Digite a senha"
      style="width:100%; padding:12px; border-radius:8px; border:1px solid #ccc;"
    >

    <button 
      onclick="login()" 
      style="margin-top:16px; width:100%; padding:12px; border:none; border-radius:8px; background:#2563eb; color:#fff; font-size:15px; cursor:pointer;">
      Entrar
    </button>

    <p id="erroLogin" style="color:#dc2626; margin-top:12px; display:none;">
      Senha incorreta
    </p>
  </div>

</div>




<header>
  <h1>üì¶ Dashboard ‚Äì Produtos Perdidos e Achados</h1>
  <button class="toggle-theme" onclick="alternarTema()">üåô Dark</button>
</header>

<div class="container">

  <div class="cards">
    <div class="card"><h3>Registros Perdidos</h3><p class="negativo" id="kpiPerdidos">0</p></div>
    <div class="card"><h3>Registros Achados</h3><p class="positivo" id="kpiAchados">0</p></div>
    <div class="card"><h3>Valor Perdido (R$)</h3><p class="negativo" id="kpiValorPerdido">0,00</p></div>
    <div class="card"><h3>Valor Recuperado (R$)</h3><p class="positivo" id="kpiValorAchado">0,00</p></div>
  </div>

  <div class="box">
    <h3>üìà Evolu√ß√£o Di√°ria ‚Äì Perdidos x Recuperados</h3>
    <canvas id="graficoDias" height="120"></canvas>
  </div>

<div class="box">
  <h3>üîç Filtro de Data para Gr√°fico</h3>
  
  <label for="filtroPeriodo">Escolha o Per√≠odo</label>
  <select id="filtroPeriodo">
    <option value="data">Data Espec√≠fica</option>
    <option value="semana">Semana</option>
    <option value="mes">M√™s</option>
  </select>

  <label for="filtroDataGrafico">Data</label>
  <input type="date" id="filtroDataGrafico">

  <button onclick="aplicarFiltroGrafico()">Aplicar Filtro</button>
</div>



<div class="box">
    <h3>1Ô∏è‚É£ Importar Planilha de Produtos (.xlsx)</h3>
    <input type="file" id="fileProdutos" accept=".xlsx">
  </div>

  <div class="box">
    <h3>2Ô∏è‚É£ Registrar Produto Perdido</h3>
    <label>C√≥digo</label>
    <input type="text" id="codigoInput">
    <label>Data da Perda</label>
    <input type="date" id="dataPerdaInput">
    <label>Quantidade</label>
    <input type="number" id="qtdInput" value="1">
    <button onclick="adicionarPerdido()">Adicionar</button>
  <h3>‚ûï Cadastrar Produto Perdido Manualmente</h3>

  <label>C√≥digo</label>
  <input type="text" id="manualCodigo">

  <label>Descri√ß√£o</label>
  <input type="text" id="manualDescricao">

  <label>Quantidade</label>
  <input type="number" id="manualQuantidade" value="1" min="1">

  <label>Valor Unit√°rio (R$)</label>
  <input type="text" id="manualValor">

  <label>Data da Perda</label>
  <input type="date" id="manualData">

  <button class="red" onclick="adicionarPerdidoManual()">Registrar Perdido</button>


</div>

 <div class="box">
  <h3>üîç Filtro de Pesquisa</h3>
  <label for="filtroCodigo">C√≥digo</label>
  <input type="text" id="filtroCodigo" placeholder="Digite o c√≥digo">

  <label for="filtroDescricao">Descri√ß√£o</label>
  <input type="text" id="filtroDescricao" placeholder="Digite a descri√ß√£o">

  <label for="filtroQuantidade">Quantidade</label>
  <input type="number" id="filtroQuantidade" placeholder="Quantidade" min="1">

  <label for="filtroData">Data da Perda</label>
  <input type="date" id="filtroData">

  <button onclick="aplicarFiltro()">Aplicar Filtro</button>
<button onclick="limparFiltro()">Limpar Filtro</button>


</div>

<div class="box">
    <h3>Produtos Perdidos</h3>
    <table id="tabelaPerdidos"><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
  </div>

  <div style="margin-top:10px;">
  <button onclick="perdidosAnterior()">‚¨Ö</button>
  <span id="infoPerdidos"></span>
  <button onclick="perdidosProxima()">‚û°</button>
</div>

<div class="box">
    <h3>Produtos Achados</h3>
    <table id="tabelaAchados"><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
  </div>

<div style="margin-top:10px;">
  <button onclick="achadosAnterior()">‚¨Ö</button>
  <span id="infoAchados"></span>
  <button onclick="achadosProxima()">‚û°</button>
</div>


  <div class="box">
    <h3>üì§ Exporta√ß√µes e Relat√≥rios</h3>
    <button onclick="exportarPerdidos()">Exportar Perdidos</button>
    <button class="green" onclick="exportarAchados()">Exportar Achados</button>
    <button style="background:#dc2626" onclick="gerarPDFPeriodo()">üìÑ Gerar Relat√≥rio em PDF (com gr√°fico)</button>
    <button style="background:#6b7280" onclick="copiarRelatorio()">üìã Copiar Relat√≥rio Completo (WhatsApp)</button>
    <br><br>
    <label>Data Inicial</label>
    <input type="date" id="dataInicio">
    <label>Data Final</label>
    <input type="date" id="dataFim">
    <button onclick="copiarRelatorioPeriodo()">üìã Copiar Relat√≥rio do Per√≠odo</button>
      

</div>

</div>

<script>

const API_URL = "https://api-produtos-fbb4.onrender.com/dados";

function login() {
  const senha = document.getElementById('senhaInput').value;

  if (senha === SENHA_SISTEMA) {
    localStorage.setItem('logado', 'true');
    document.getElementById('loginScreen').style.display = 'none';
  } else {
    document.getElementById('erroLogin').style.display = 'block';
  }
}

function logout() {
  localStorage.removeItem('logado');
  location.reload();
}

window.addEventListener('load', () => {
  if (localStorage.getItem('logado') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
  }
});


/* bloqueia click do mause */ 

/* bloqueia F12 */

document.addEventListener('keydown', function (e) {
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key)) ||
    (e.ctrlKey && e.key === "U")
  ) {
    e.preventDefault();
  }
});


document.addEventListener('contextmenu', function (e) {
  e.preventDefault();
});



function exportarPerdidos() {
  if (!perdidos.length) {
    alert('N√£o h√° produtos perdidos');
    return;
  }

  const dados = perdidos.map(p => ({
    'Data Perdido': p.data,
    C√≥digo: p.codigo,
    Descri√ß√£o: p.descricao,
    Quantidade: p.quantidade,
    'Valor Unit√°rio': p.valorUnitario,
    'Valor Total': p.valorTotal
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Perdidos');
  XLSX.writeFile(wb, 'produtos_perdidos.xlsx');
}


/* ================= DARK MODE ================= */
function alternarTema() {
  document.body.classList.toggle('dark');
  localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
}

window.onload = function () {
  if (localStorage.getItem('tema') === 'dark') {
    document.body.classList.add('dark');
  }
};

/* ================= DADOS ================= */
let produtosBase = [];
let perdidos = [];
let achados = [];
let graficoDias = null;

function parseValorBR(valor) {
  if (!valor) return 0;
  let v = String(valor).trim();
  if (v.includes(',') && !v.includes('.')) return Number(v.replace(',', '.')) || 0;
  if (v.includes(',') && v.includes('.')) return Number(v.replace(/\./g, '').replace(',', '.')) || 0;
  return Number(v) || 0;
}

async function carregarDados() {
  const r = await fetch(API_URL);
  const data = await r.json();

  perdidos = data.perdidos || [];
  achados = data.achados || [];

  render();
  criarGraficos();
}

async function salvar() {
  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ perdidos, achados })
  });

  render();
  criarGraficos();
}



/* ================= IMPORTA√á√ÉO ================= */
document.getElementById('fileProdutos').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    produtosBase = XLSX.utils.sheet_to_json(sheet, {
      defval: '',
      raw: false,
      header: ['Produto', 'Digito', 'Descri√ß√£o Produto', 'Coluna4', 'Endereco', 'Valor CMPG'],
      range: 1
    });

    alert('Planilha carregada com sucesso');
  };
  reader.readAsArrayBuffer(file);
});

/* ================= CADASTRO ================= */
function adicionarPerdido() {
  const codigo = document.getElementById('codigoInput').value.trim();
  const quantidade = Number(document.getElementById('qtdInput').value) || 1;
  const dataPerda = document.getElementById('dataPerdaInput').value || new Date().toISOString().slice(0,10);

  if (!codigo || !produtosBase.length) return alert('C√≥digo ou planilha inv√°lidos');

  const produto = produtosBase.find(p =>
    String(p.Produto).replace('.0','') + String(p.Digito).replace('.0','') === codigo
  );

  if (!produto) return alert('Produto n√£o encontrado');

  const valorUnit = parseValorBR(produto['Valor CMPG']);

  perdidos.push({
    data: dataPerda,
    codigo,
    descricao: produto['Descri√ß√£o Produto'],
    quantidade,
    valorUnitario: valorUnit,
    valorTotal: valorUnit * quantidade
  });

  salvar();
}

function editarItem(index) {
  const item = perdidos[index];
  const novaQtd = prompt('Editar quantidade:', item.quantidade);
  if (novaQtd === null) return;
  const novoValor = prompt('Editar valor unit√°rio:', item.valorUnitario);
  if (novoValor === null) return;

  const qtdNum = Number(novaQtd);
  const valorNum = parseValorBR(novoValor);

  if (qtdNum <= 0 || valorNum < 0) return alert('Valores inv√°lidos');

  item.quantidade = qtdNum;
  item.valorUnitario = valorNum;
  item.valorTotal = qtdNum * valorNum;

  salvar();
}

function excluirPerdido(index) {
  if (!confirm('Excluir registro perdido?')) return;
  perdidos.splice(index, 1);
  salvar();
}

function excluirAchado(index) {
  if (!confirm('Excluir registro achado?')) return;
  achados.splice(index, 1);
  salvar();
}

function moverParaAchado(index) {
  const item = perdidos[index];
  const dataEscolhida = prompt('Data do achado (AAAA-MM-DD):', new Date().toISOString().slice(0,10));
  if (!dataEscolhida) return;

  item.dataAchado = dataEscolhida;
  achados.push(item);
  perdidos.splice(index, 1);
  salvar();
}



const SENHA_SISTEMA = "120518"; // üîê troque pela senha desejada





/* ================= RENDER / SALVAR ================= */



let valorPerdidoTotal = 0;
let valorAchadoTotal = 0;

perdidos.forEach(p => {
  valorPerdidoTotal += Number(p.valorTotal) || 0;
});

achados.forEach(a => {
  valorAchadoTotal += Number(a.valorTotal) || 0;
});


function render() {
  const tbP = document.querySelector('#tabelaPerdidos tbody');
  const tbA = document.querySelector('#tabelaAchados tbody');

  tbP.innerHTML = '';
  tbA.innerHTML = '';

  const inicioP = (paginaPerdidos - 1) * itensPorPagina;
  const fimP = inicioP + itensPorPagina;

  perdidos.slice(inicioP, fimP).forEach((p, i) => {
    tbP.innerHTML += `<tr>
      <td data-label="C√≥digo">${p.codigo}</td>
      <td data-label="Descri√ß√£o">${p.descricao}</td>
      <td data-label="Qtd">${p.quantidade}</td>
      <td data-label="Valor Unit.">R$ ${p.valorUnitario.toFixed(2)}</td>
      <td data-label="Total">R$ ${p.valorTotal.toFixed(2)}</td>
      <td data-label="A√ß√µes">
        <button onclick="editarItem(${inicioP + i})">‚úèÔ∏è Editar</button>
        <button class="green" onclick="moverParaAchado(${inicioP + i})">‚úÖ Achado</button>
        <button class="red" onclick="excluirPerdido(${inicioP + i})">üóë Excluir</button>
      </td>
    </tr>`;
  });

  document.getElementById('infoPerdidos').textContent =
    `P√°gina ${paginaPerdidos} de ${Math.ceil(perdidos.length / itensPorPagina) || 1}`;

  const inicioA = (paginaAchados - 1) * itensPorPagina;
  const fimA = inicioA + itensPorPagina;

  achados.slice(inicioA, fimA).forEach((a, i) => {
    tbA.innerHTML += `<tr>
      <td data-label="C√≥digo">${a.codigo}</td>
      <td data-label="Descri√ß√£o">${a.descricao}</td>
      <td data-label="Qtd">${a.quantidade}</td>
      <td data-label="Valor Unit.">R$ ${a.valorUnitario.toFixed(2)}</td>
      <td data-label="Total">R$ ${a.valorTotal.toFixed(2)}</td>
      <td data-label="A√ß√µes">
        <button class="red" onclick="excluirAchado(${inicioA + i})">üóë Excluir</button>
      </td>
    </tr>`;
  });

  document.getElementById('infoAchados').textContent =
    `P√°gina ${paginaAchados} de ${Math.ceil(achados.length / itensPorPagina) || 1}`;

  document.getElementById('kpiPerdidos').textContent = perdidos.length;
  document.getElementById('kpiAchados').textContent = achados.length;

  document.getElementById('kpiValorPerdido').textContent =
    perdidos.reduce((s, p) => s + p.valorTotal, 0).toFixed(2);

  document.getElementById('kpiValorAchado').textContent =
    achados.reduce((s, a) => s + a.valorTotal, 0).toFixed(2);
}



function perdidosProxima() {
  if (paginaPerdidos < Math.ceil(perdidos.length / itensPorPagina)) {
    paginaPerdidos++;
    render();
  }
}

function perdidosAnterior() {
  if (paginaPerdidos > 1) {
    paginaPerdidos--;
    render();
  }
}

function achadosProxima() {
  if (paginaAchados < Math.ceil(achados.length / itensPorPagina)) {
    paginaAchados++;
    render();
  }
}

function achadosAnterior() {
  if (paginaAchados > 1) {
    paginaAchados--;
    render();
  }
}





/* ================= GR√ÅFICO ================= */
function criarGraficos() {
  const mapaDias = {};

  perdidos.forEach(p => {
    if (!mapaDias[p.data]) mapaDias[p.data] = { perdidos: 0, recuperados: 0 };
    mapaDias[p.data].perdidos += p.valorTotal;
  });

  achados.forEach(a => {
    if (!mapaDias[a.dataAchado]) mapaDias[a.dataAchado] = { perdidos: 0, recuperados: 0 };
    mapaDias[a.dataAchado].recuperados += a.valorTotal;
  });

  const datas = Object.keys(mapaDias).sort();

  if (graficoDias) graficoDias.destroy();

  graficoDias = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: {
      labels: datas,
      datasets: [
        { label: 'Perdidos (R$)', data: datas.map(d => mapaDias[d].perdidos), borderColor: '#dc2626', tension: 0.4 },
        { label: 'Recuperados (R$)', data: datas.map(d => mapaDias[d].recuperados), borderColor: '#16a34a', tension: 0.4 }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}


/* busca de produto */ 


function aplicarFiltro() {
  // Obter os valores dos filtros
  const codigo = document.getElementById('filtroCodigo').value.toLowerCase();
  const descricao = document.getElementById('filtroDescricao').value.toLowerCase();
  const quantidade = Number(document.getElementById('filtroQuantidade').value) || 0;
  const data = document.getElementById('filtroData').value;

  // Filtrar produtos perdidos
  const produtosFiltradosPerdidos = perdidos.filter(p => {
    const correspondeCodigo = p.codigo.toLowerCase().includes(codigo);
    const correspondeDescricao = p.descricao.toLowerCase().includes(descricao);
    const correspondeQuantidade = p.quantidade >= quantidade;
    const correspondeData = data ? p.data === data : true;

    return correspondeCodigo && correspondeDescricao && correspondeQuantidade && correspondeData;
  });

  // Filtrar produtos achados
  const produtosFiltradosAchados = achados.filter(a => {
    const correspondeCodigo = a.codigo.toLowerCase().includes(codigo);
    const correspondeDescricao = a.descricao.toLowerCase().includes(descricao);
    const correspondeQuantidade = a.quantidade >= quantidade;
    const correspondeData = data ? a.dataAchado === data : true;

    return correspondeCodigo && correspondeDescricao && correspondeQuantidade && correspondeData;
  });

  // Re-renderizar as tabelas com os produtos filtrados
  renderTabela(produtosFiltradosPerdidos, 'Perdidos');
  renderTabela(produtosFiltradosAchados, 'Achados');
}

function renderTabela(produtos, tipo) {
  const tabela = tipo === 'Perdidos' ? document.querySelector('#tabelaPerdidos tbody') : document.querySelector('#tabelaAchados tbody');
  tabela.innerHTML = '';

  produtos.forEach((p, i) => {
    const linha = tipo === 'Perdidos' 
      ? `<tr>
          <td data-label="C√≥digo">${p.codigo}</td>
          <td data-label="Descri√ß√£o">${p.descricao}</td>
          <td data-label="Qtd">${p.quantidade}</td>
          <td data-label="Valor Unit.">R$ ${p.valorUnitario.toFixed(2)}</td>
          <td data-label="Total">R$ ${p.valorTotal.toFixed(2)}</td>
          <td data-label="A√ß√µes">
            <button onclick="editarItem(${i}, 'Perdidos')">‚úèÔ∏è Editar</button>
            <button class="green" onclick="moverParaAchado(${i})">‚úÖ Achado</button>
            <button class="red" onclick="excluirPerdido(${i})">üóë Excluir</button>
          </td>
        </tr>`
      : `<tr>
          <td data-label="C√≥digo">${p.codigo}</td>
          <td data-label="Descri√ß√£o">${p.descricao}</td>
          <td data-label="Qtd">${p.quantidade}</td>
          <td data-label="Valor Unit.">R$ ${p.valorUnitario.toFixed(2)}</td>
          <td data-label="Total">R$ ${p.valorTotal.toFixed(2)}</td>
          <td data-label="A√ß√µes">
            <button class="red" onclick="excluirAchado(${i})">üóë Excluir</button>
          </td>
        </tr>`;

    tabela.innerHTML += linha;
  });
}

function limparFiltro() {
  document.getElementById('filtroCodigo').value = '';
  document.getElementById('filtroDescricao').value = '';
  document.getElementById('filtroQuantidade').value = '';
  document.getElementById('filtroData').value = '';
  aplicarFiltro(); // Reaplica os filtros (agora sem nenhum filtro ativo)
}




/* ================= EXPORTA√á√ÉO ================= */

function criarGraficos() {
  const mapaDias = {};

  // üî¥ TODOS os perdidos (TOTAL GERAL)
  perdidos.forEach(p => {
    if (!p.data) return;

    const data = p.data; // j√° vem yyyy-mm-dd

    if (!mapaDias[data]) {
      mapaDias[data] = { perdidos: 0, recuperados: 0 };
    }

    mapaDias[data].perdidos += Number(p.valorTotal) || 0;
  });

  // üü¢ TODOS os achados (TOTAL GERAL)
  achados.forEach(a => {
    if (!a.dataAchado) return;

    const data = a.dataAchado;

    if (!mapaDias[data]) {
      mapaDias[data] = { perdidos: 0, recuperados: 0 };
    }

    mapaDias[data].recuperados += Number(a.valorTotal) || 0;
  });

  // Ordena datas corretamente
  const datas = Object.keys(mapaDias).sort(
    (a, b) => new Date(a) - new Date(b)
  );

  // Destr√≥i gr√°fico anterior
  if (graficoDias) graficoDias.destroy();

  graficoDias = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: {
      labels: datas,
      datasets: [
        {
          label: 'üî¥ Perdidos (R$)',
          data: datas.map(d => mapaDias[d].perdidos),
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220,38,38,0.15)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'üü¢ Recuperados (R$)',
          data: datas.map(d => mapaDias[d].recuperados),
          borderColor: '#16a34a',
          backgroundColor: 'rgba(22,163,74,0.15)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx =>
              `${ctx.dataset.label}: R$ ${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}



function exportarAchados() {
  if (!achados.length) return alert('N√£o h√° produtos achados');

  const dados = achados.map(a => ({
    'Data Perdido': a.data,
    'Data Achado': a.dataAchado,
    C√≥digo: a.codigo,
    Descri√ß√£o: a.descricao,
    Quantidade: a.quantidade,
    'Valor Unit√°rio': a.valorUnitario,
    'Valor Total': a.valorTotal
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Achados');
  XLSX.writeFile(wb, 'produtos_achados.xlsx');
}

/* ================= RELAT√ìRIOS ================= */
function copiarRelatorio() {
  let totalPerdidos = perdidos.length;
  let totalAchados = achados.length;

  let valorPerdido = 0;
  let valorAchado = 0;

  perdidos.forEach(p => valorPerdido += p.valorTotal);
  achados.forEach(a => valorAchado += a.valorTotal);

  let texto = `RELAT√ìRIO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n\n`;

  texto += `üî¥ Total de registros perdidos: ${totalPerdidos}\n`;
  texto += `üü¢ Total de registros recuperados: ${totalAchados}\n\n`;

  texto += `üí∏ Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `üí∞ Valor total recuperado (estoque evitado de corte): R$ ${valorAchado.toFixed(2)}\n\n`;

  if (perdidos.length) {
    texto += `üì¶ LISTA DE PRODUTOS PERDIDOS:\n`;
    perdidos.forEach(p => {
      texto += `- ${p.codigo} | ${p.descricao} | Qtd: ${p.quantidade} | R$ ${p.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  if (achados.length) {
    texto += `üì¶ LISTA DE PRODUTOS RECUPERADOS:\n`;
    achados.forEach(a => {
      texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  const hoje = new Date().toLocaleDateString('pt-BR');
  texto += `üìÖ Relat√≥rio gerado em: ${hoje}`;

  navigator.clipboard.writeText(texto);
  alert('Relat√≥rio copiado! Cole direto no WhatsApp ‚úÖ');
}

function copiarRelatorioPeriodo() {
  const ini = document.getElementById('dataInicio').value;
  const fim = document.getElementById('dataFim').value;

  if (!ini || !fim) {
    alert('Informe o per√≠odo');
    return;
  }

  const perdidosPeriodo = perdidos.filter(p => p.data >= ini && p.data <= fim);
  const achadosPeriodo = achados.filter(a => a.dataAchado >= ini && a.dataAchado <= fim);

  let totalPerdidos = perdidosPeriodo.length;
  let totalAchados = achadosPeriodo.length;

  let valorPerdido = 0;
  let valorAchado = 0;

  perdidosPeriodo.forEach(p => valorPerdido += p.valorTotal);
  achadosPeriodo.forEach(a => valorAchado += a.valorTotal);

  let texto = `RELAT√ìRIO POR PER√çODO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n`;
  texto += `üìÖ Per√≠odo: ${ini} at√© ${fim}\n\n`;

  texto += `üî¥ Total de registros perdidos: ${totalPerdidos}\n`;
  texto += `üü¢ Total de registros recuperados: ${totalAchados}\n\n`;

  texto += `üí∏ Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `üí∞ Valor total recuperado (estoque evitado de corte): R$ ${valorAchado.toFixed(2)}\n\n`;

  if (perdidosPeriodo.length) {
    texto += `üì¶ LISTA DE PRODUTOS PERDIDOS:\n`;
    perdidosPeriodo.forEach(p => {
      texto += `- ${p.codigo} | ${p.descricao} | Qtd: ${p.quantidade} | R$ ${p.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  if (achadosPeriodo.length) {
    texto += `üì¶ LISTA DE PRODUTOS RECUPERADOS:\n`;
    achadosPeriodo.forEach(a => {
      texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  const hoje = new Date().toLocaleDateString('pt-BR');
  texto += `üìÖ Relat√≥rio gerado em: ${hoje}`;

  navigator.clipboard.writeText(texto);
  alert('Relat√≥rio do per√≠odo copiado! Cole direto no WhatsApp ‚úÖ');
}

async function gerarPDFPeriodo() {

  const inicio = document.getElementById('dataInicio').value;
  const fim = document.getElementById('dataFim').value;

  if (!inicio || !fim) {
    alert('Informe a data inicial e a data final');
    return;
  }

  const dataInicio = new Date(inicio);
  const dataFim = new Date(fim);

  const perdidosPeriodo = perdidos.filter(p => {
    const d = new Date(p.data);
    return d >= dataInicio && d <= dataFim;
  });

  const achadosPeriodo = achados.filter(a => {
    const d = new Date(a.dataAchado);
    return d >= dataInicio && d <= dataFim;
  });

  if (!perdidosPeriodo.length && !achadosPeriodo.length) {
    alert('N√£o h√° dados neste per√≠odo');
    return;
  }

  let qtdPerdida = 0;
  let qtdRecuperada = 0;
  let valorPerdido = 0;
  let valorRecuperado = 0;

  perdidosPeriodo.forEach(p => {
    qtdPerdida += p.quantidade;
    valorPerdido += p.valorTotal;
  });

  achadosPeriodo.forEach(a => {
    qtdRecuperada += a.quantidade;
    valorRecuperado += a.valorTotal;
  });

  const percQtd = qtdPerdida > 0 ? (qtdRecuperada / qtdPerdida) * 100 : 0;
  const percValor = valorPerdido > 0 ? (valorRecuperado / valorPerdido) * 100 : 0;

  /* ===== TEXTO DO RELAT√ìRIO ===== */

  let texto = `RELAT√ìRIO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n\n`;
  texto += `Per√≠odo: ${inicio} at√© ${fim}\n\n`;

  texto += `Total de registros perdidos: ${perdidosPeriodo.length}\n`;
  texto += `Total de registros recuperados: ${achadosPeriodo.length}\n\n`;

  texto += `Quantidade perdida: ${qtdPerdida}\n`;
  texto += `Quantidade recuperada: ${qtdRecuperada}\n\n`;

  texto += `Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `Valor recuperado (estoque evitado de corte): R$ ${valorRecuperado.toFixed(2)}\n\n`;

  texto += `Percentual de recupera√ß√£o:\n`;
  texto += `- Por quantidade: ${percQtd.toFixed(1)}%\n`;
  texto += `- Por valor: ${percValor.toFixed(1)}%\n\n`;

  texto += `Produtos recuperados:\n`;

  achadosPeriodo.forEach(a => {
    texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
  });

  texto += `\nRelat√≥rio gerado em: ${new Date().toLocaleDateString()}`;

  /* ===== GERAR PDF ===== */

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Texto no PDF
  const linhas = doc.splitTextToSize(texto, 180);
  doc.text(linhas, 10, 15);

  // Capturar gr√°fico como imagem
  const canvasGrafico = document.getElementById('graficoDias');

  if (canvasGrafico) {
    const imagem = await html2canvas(canvasGrafico);
    const imgData = imagem.toDataURL('image/png');

    doc.addPage();
    doc.text("Gr√°fico ‚Äì Evolu√ß√£o Perdidos x Recuperados", 10, 15);
    doc.addImage(imgData, 'PNG', 10, 25, 180, 90);
  }

  const nomeArquivo = `relatorio_perdidos_achados_${inicio}_a_${fim}.pdf`;
  doc.save(nomeArquivo);
}

carregarDados();


function adicionarPerdidoManual() {
  const codigo = document.getElementById('manualCodigo').value.trim();
  const descricao = document.getElementById('manualDescricao').value.trim();
  const quantidade = Number(document.getElementById('manualQuantidade').value);
  const valorUnitario = parseValorBR(document.getElementById('manualValor').value);
  const data = document.getElementById('manualData').value || new Date().toISOString().slice(0,10);

  if (!codigo || !descricao || quantidade <= 0 || valorUnitario <= 0) {
    alert('Preencha todos os campos corretamente');
    return;
  }

  perdidos.push({
    data,
    codigo,
    descricao,
    quantidade,
    valorUnitario,
    valorTotal: quantidade * valorUnitario
  });

  salvar(); // üî• SALVO ONLINE NO RENDER

  document.getElementById('manualCodigo').value = '';
  document.getElementById('manualDescricao').value = '';
  document.getElementById('manualQuantidade').value = 1;
  document.getElementById('manualValor').value = '';
  document.getElementById('manualData').value = '';

  alert('Produto perdido registrado e salvo online ‚úÖ');
}

let paginaPerdidos = 1;
let paginaAchados = 1;
const itensPorPagina = 10;

/* filtro por dara grafico */


function aplicarFiltroGrafico() {
  const periodo = document.getElementById('filtroPeriodo').value;
  const dataEscolhida = document.getElementById('filtroDataGrafico').value;
  
  let mapaDias = {};

  // Fun√ß√£o para agrupar dados por m√™s
  const agruparPorMes = (data) => {
    const mes = new Date(data).toISOString().slice(0, 7); // 'YYYY-MM'
    return mes;
  };

  // Fun√ß√£o para agrupar dados por semana
  const agruparPorSemana = (data) => {
    const date = new Date(data);
    const startDate = new Date(date.setDate(date.getDate() - date.getDay())); // Domingo da semana
    return startDate.toISOString().slice(0, 10); // 'YYYY-MM-DD'
  };

  // Fun√ß√£o para agrupar por data espec√≠fica
  const agruparPorData = (data) => {
    return data;
  };

  // Fun√ß√£o para agrupar os dados com base no filtro selecionado
  const agruparDados = (data, tipo) => {
    switch (tipo) {
      case 'semana':
        return agruparPorSemana(data);
      case 'mes':
        return agruparPorMes(data);
      case 'data':
      default:
        return agruparPorData(data);
    }
  };

  // Filtra e agrupa os produtos perdidos
  perdidos.forEach(p => {
    const chave = agruparDados(p.data, periodo);
    if (!mapaDias[chave]) mapaDias[chave] = { perdidos: 0, recuperados: 0 };
    mapaDias[chave].perdidos += p.valorTotal;
  });

  // Filtra e agrupa os produtos achados
  achados.forEach(a => {
    const chave = agruparDados(a.dataAchado, periodo);
    if (!mapaDias[chave]) mapaDias[chave] = { perdidos: 0, recuperados: 0 };
    mapaDias[chave].recuperados += a.valorTotal;
  });

  const datas = Object.keys(mapaDias).sort();
  criarGrafico(datas, mapaDias);
}

function criarGrafico(datas, mapaDias) {
  if (graficoDias) graficoDias.destroy(); // Destruir gr√°fico anterior

  graficoDias = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: {
      labels: datas,
      datasets: [
        {
          label: 'üî¥ Perdidos (R$)',
          data: datas.map(d => mapaDias[d].perdidos),
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220,38,38,0.15)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'üü¢ Recuperados (R$)',
          data: datas.map(d => mapaDias[d].recuperados),
          borderColor: '#16a34a',
          backgroundColor: 'rgba(22,163,74,0.15)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: R$ ${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}


</script>

</body>
</html>

