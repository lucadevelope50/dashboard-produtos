<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Offline ‚Äì Produtos Perdidos e Achados v5.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg: #f4f6f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --border: #334155;
      --shadow: 0 6px 18px rgba(0,0,0,.4);
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background .3s, color .3s;
    }

    header {
      background: linear-gradient(90deg, #1f2937, #111827);
      color: #fff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { margin: 0; font-size: 20px; }

    .toggle-theme {
      background: none;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
    }

    .container { padding: 24px; max-width: 1400px; margin: auto; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
      transition: transform .2s;
    }

    .card:hover { transform: translateY(-4px); }

    .card h3 { margin: 0; font-size: 13px; color: var(--muted); }
    .card p { font-size: 28px; margin: 8px 0 0; font-weight: bold; }

    .negativo { color: var(--danger); }
    .positivo { color: var(--success); }

    .box {
      background: var(--card);
      padding: 22px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      margin-top: 24px;
    }

    input, button {
      padding: 10px;
      margin-top: 6px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    input { background: var(--bg); }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: opacity .2s, transform .1s;
    }

    button:hover { opacity: .9; transform: scale(1.01); }

    button.green { background: var(--success); }
    button.red { background: var(--danger); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      table-layout: fixed;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      text-align: center;
    }

    th { background: rgba(0,0,0,.03); color: var(--muted); }

    tbody tr:hover { background: rgba(0,0,0,.04); }
  </style>
</head>
<body>

<header>
  <h1>üì¶ Dashboard ‚Äì Produtos Perdidos e Achados</h1>
  <button class="toggle-theme" onclick="alternarTema()">üåô Dark</button>
</header>

<div class="container">

  <div class="cards">
    <div class="card"><h3>Registros Perdidos</h3><p class="negativo" id="kpiPerdidos">0</p></div>
    <div class="card"><h3>Registros Achados</h3><p class="positivo" id="kpiAchados">0</p></div>
    <div class="card"><h3>Valor Perdido (R$)</h3><p class="negativo" id="kpiValorPerdido">0,00</p></div>
    <div class="card"><h3>Valor Recuperado (R$)</h3><p class="positivo" id="kpiValorAchado">0,00</p></div>
  </div>

  <div class="box">
    <h3>üìà Evolu√ß√£o Di√°ria ‚Äì Perdidos x Recuperados</h3>
    <canvas id="graficoDias" height="120"></canvas>
  </div>

  <div class="box">
    <h3>1Ô∏è‚É£ Importar Planilha de Produtos (.xlsx)</h3>
    <input type="file" id="fileProdutos" accept=".xlsx">
  </div>

  <div class="box">
    <h3>2Ô∏è‚É£ Registrar Produto Perdido</h3>
    <label>C√≥digo</label>
    <input type="text" id="codigoInput">
    <label>Data da Perda</label>
    <input type="date" id="dataPerdaInput">
    <label>Quantidade</label>
    <input type="number" id="qtdInput" value="1">
    <button onclick="adicionarPerdido()">Adicionar</button>
  </div>

  <div class="box">
    <h3>Produtos Perdidos</h3>
    <table id="tabelaPerdidos"><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="box">
    <h3>Produtos Achados</h3>
    <table id="tabelaAchados"><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>Qtd</th><th>Valor Unit.</th><th>Total</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="box">
    <h3>üì§ Exporta√ß√µes e Relat√≥rios</h3>
    <button onclick="exportarPerdidos()">Exportar Perdidos</button>
    <button class="green" onclick="exportarAchados()">Exportar Achados</button>
    <button style="background:#dc2626" onclick="gerarPDFPeriodo()">üìÑ Gerar Relat√≥rio em PDF (com gr√°fico)</button>
    <button style="background:#6b7280" onclick="copiarRelatorio()">üìã Copiar Relat√≥rio Completo (WhatsApp)</button>
    <br><br>
    <label>Data Inicial</label>
    <input type="date" id="dataInicio">
    <label>Data Final</label>
    <input type="date" id="dataFim">
    <button onclick="copiarRelatorioPeriodo()">üìã Copiar Relat√≥rio do Per√≠odo</button>
  </div>

</div>

<script>

const API_URL = "https://api-produtos-fbb4.onrender.com/dados";



/* ================= DARK MODE ================= */
function alternarTema() {
  document.body.classList.toggle('dark');
  localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
}

window.onload = function () {
  if (localStorage.getItem('tema') === 'dark') {
    document.body.classList.add('dark');
  }
};

/* ================= DADOS ================= */
let produtosBase = [];
let perdidos = [];
let achados = [];
let graficoDias = null;

function parseValorBR(valor) {
  if (!valor) return 0;
  let v = String(valor).trim();
  if (v.includes(',') && !v.includes('.')) return Number(v.replace(',', '.')) || 0;
  if (v.includes(',') && v.includes('.')) return Number(v.replace(/\./g, '').replace(',', '.')) || 0;
  return Number(v) || 0;
}

async function carregarDados() {
  const r = await fetch(API_URL);
  const data = await r.json();

  perdidos = data.perdidos || [];
  achados = data.achados || [];

  render();
  criarGraficos();
}

async function salvar() {
  await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ perdidos, achados })
  });

  render();
  criarGraficos();
}



/* ================= IMPORTA√á√ÉO ================= */
document.getElementById('fileProdutos').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    produtosBase = XLSX.utils.sheet_to_json(sheet, {
      defval: '',
      raw: false,
      header: ['Produto', 'Digito', 'Descri√ß√£o Produto', 'Coluna4', 'Endereco', 'Valor CMPG'],
      range: 1
    });

    alert('Planilha carregada com sucesso');
  };
  reader.readAsArrayBuffer(file);
});

/* ================= CADASTRO ================= */
function adicionarPerdido() {
  const codigo = document.getElementById('codigoInput').value.trim();
  const quantidade = Number(document.getElementById('qtdInput').value) || 1;
  const dataPerda = document.getElementById('dataPerdaInput').value || new Date().toISOString().slice(0,10);

  if (!codigo || !produtosBase.length) return alert('C√≥digo ou planilha inv√°lidos');

  const produto = produtosBase.find(p =>
    String(p.Produto).replace('.0','') + String(p.Digito).replace('.0','') === codigo
  );

  if (!produto) return alert('Produto n√£o encontrado');

  const valorUnit = parseValorBR(produto['Valor CMPG']);

  perdidos.push({
    data: dataPerda,
    codigo,
    descricao: produto['Descri√ß√£o Produto'],
    quantidade,
    valorUnitario: valorUnit,
    valorTotal: valorUnit * quantidade
  });

  salvar();
}

function editarItem(index) {
  const item = perdidos[index];
  const novaQtd = prompt('Editar quantidade:', item.quantidade);
  if (novaQtd === null) return;
  const novoValor = prompt('Editar valor unit√°rio:', item.valorUnitario);
  if (novoValor === null) return;

  const qtdNum = Number(novaQtd);
  const valorNum = parseValorBR(novoValor);

  if (qtdNum <= 0 || valorNum < 0) return alert('Valores inv√°lidos');

  item.quantidade = qtdNum;
  item.valorUnitario = valorNum;
  item.valorTotal = qtdNum * valorNum;

  salvar();
}

function excluirPerdido(index) {
  if (!confirm('Excluir registro perdido?')) return;
  perdidos.splice(index, 1);
  salvar();
}

function excluirAchado(index) {
  if (!confirm('Excluir registro achado?')) return;
  achados.splice(index, 1);
  salvar();
}

function moverParaAchado(index) {
  const item = perdidos[index];
  const dataEscolhida = prompt('Data do achado (AAAA-MM-DD):', new Date().toISOString().slice(0,10));
  if (!dataEscolhida) return;

  item.dataAchado = dataEscolhida;
  achados.push(item);
  perdidos.splice(index, 1);
  salvar();
}

/* ================= RENDER / SALVAR ================= */

async function salvar() {
  await fetch(API_URL, {
    method: 'POST',
    mode: 'no-cors',
    body: JSON.stringify({ perdidos, achados })
  });

  // N√ÉO chama render aqui
  // os dados j√° est√£o na mem√≥ria
}

  
async function carregarDados() {
  const r = await fetch(API_URL);
  const data = await r.json();
  perdidos = data.perdidos || [];
  achados = data.achados || [];
  render();
  criarGraficos();
}


function render() {
  const tbP = document.querySelector('#tabelaPerdidos tbody');
  const tbA = document.querySelector('#tabelaAchados tbody');
  tbP.innerHTML = '';
  tbA.innerHTML = '';

  let valorPerdido = 0;
  let valorAchado = 0;

  perdidos.forEach((p, i) => {
    valorPerdido += p.valorTotal;
    tbP.innerHTML += `<tr>
      <td>${p.codigo}</td>
      <td>${p.descricao}</td>
      <td>${p.quantidade}</td>
      <td>${p.valorUnitario.toFixed(2)}</td>
      <td>${p.valorTotal.toFixed(2)}</td>
      <td>
        <button onclick="editarItem(${i})">Editar</button>
        <button class="green" onclick="moverParaAchado(${i})">Achado</button>
        <button class="red" onclick="excluirPerdido(${i})">Excluir</button>
      </td>
    </tr>`;
  });

  achados.forEach((a, i) => {
    valorAchado += a.valorTotal;
    tbA.innerHTML += `<tr>
      <td>${a.codigo}</td>
      <td>${a.descricao}</td>
      <td>${a.quantidade}</td>
      <td>${a.valorUnitario.toFixed(2)}</td>
      <td>${a.valorTotal.toFixed(2)}</td>
      <td><button class="red" onclick="excluirAchado(${i})">Excluir</button></td>
    </tr>`;
  });

  document.getElementById('kpiPerdidos').textContent = perdidos.length;
  document.getElementById('kpiAchados').textContent = achados.length;
  document.getElementById('kpiValorPerdido').textContent = valorPerdido.toFixed(2);
  document.getElementById('kpiValorAchado').textContent = valorAchado.toFixed(2);
}

/* ================= GR√ÅFICO ================= */
function criarGraficos() {
  const mapaDias = {};

  perdidos.forEach(p => {
    if (!mapaDias[p.data]) mapaDias[p.data] = { perdidos: 0, recuperados: 0 };
    mapaDias[p.data].perdidos += p.valorTotal;
  });

  achados.forEach(a => {
    if (!mapaDias[a.dataAchado]) mapaDias[a.dataAchado] = { perdidos: 0, recuperados: 0 };
    mapaDias[a.dataAchado].recuperados += a.valorTotal;
  });

  const datas = Object.keys(mapaDias).sort();

  if (graficoDias) graficoDias.destroy();

  graficoDias = new Chart(document.getElementById('graficoDias'), {
    type: 'line',
    data: {
      labels: datas,
      datasets: [
        { label: 'Perdidos (R$)', data: datas.map(d => mapaDias[d].perdidos), borderColor: '#dc2626', tension: 0.4 },
        { label: 'Recuperados (R$)', data: datas.map(d => mapaDias[d].recuperados), borderColor: '#16a34a', tension: 0.4 }
      ]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

/* ================= EXPORTA√á√ÉO ================= */
function exportarPerdidos() {
  if (!perdidos.length) return alert('N√£o h√° produtos perdidos');

  const dados = perdidos.map(p => ({
    Data: p.data,
    C√≥digo: p.codigo,
    Descri√ß√£o: p.descricao,
    Quantidade: p.quantidade,
    'Valor Unit√°rio': p.valorUnitario,
    'Valor Total': p.valorTotal
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Perdidos');
  XLSX.writeFile(wb, 'produtos_perdidos.xlsx');
}

function exportarAchados() {
  if (!achados.length) return alert('N√£o h√° produtos achados');

  const dados = achados.map(a => ({
    'Data Perdido': a.data,
    'Data Achado': a.dataAchado,
    C√≥digo: a.codigo,
    Descri√ß√£o: a.descricao,
    Quantidade: a.quantidade,
    'Valor Unit√°rio': a.valorUnitario,
    'Valor Total': a.valorTotal
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Achados');
  XLSX.writeFile(wb, 'produtos_achados.xlsx');
}

/* ================= RELAT√ìRIOS ================= */
function copiarRelatorio() {
  let totalPerdidos = perdidos.length;
  let totalAchados = achados.length;

  let valorPerdido = 0;
  let valorAchado = 0;

  perdidos.forEach(p => valorPerdido += p.valorTotal);
  achados.forEach(a => valorAchado += a.valorTotal);

  let texto = `RELAT√ìRIO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n\n`;

  texto += `üî¥ Total de registros perdidos: ${totalPerdidos}\n`;
  texto += `üü¢ Total de registros recuperados: ${totalAchados}\n\n`;

  texto += `üí∏ Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `üí∞ Valor total recuperado (estoque evitado de corte): R$ ${valorAchado.toFixed(2)}\n\n`;

  if (perdidos.length) {
    texto += `üì¶ LISTA DE PRODUTOS PERDIDOS:\n`;
    perdidos.forEach(p => {
      texto += `- ${p.codigo} | ${p.descricao} | Qtd: ${p.quantidade} | R$ ${p.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  if (achados.length) {
    texto += `üì¶ LISTA DE PRODUTOS RECUPERADOS:\n`;
    achados.forEach(a => {
      texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  const hoje = new Date().toLocaleDateString('pt-BR');
  texto += `üìÖ Relat√≥rio gerado em: ${hoje}`;

  navigator.clipboard.writeText(texto);
  alert('Relat√≥rio copiado! Cole direto no WhatsApp ‚úÖ');
}


function adicionarProduto(tipo) {
  const nome = document.getElementById('nome').value.trim();
  const local = document.getElementById('local').value.trim();
  const data = document.getElementById('data').value;
  const descricao = document.getElementById('descricao').value.trim();

  if (!nome) {
    alert('Informe o nome do produto');
    return;
  }

  const produto = {
    nome,
    local,
    data,
    descricao
  };

  if (tipo === 'perdido') {
    perdidos.push(produto);
  } else {
    achados.push(produto);
  }

  salvar();

  // limpa formul√°rio
  document.getElementById('nome').value = '';
  document.getElementById('local').value = '';
  document.getElementById('data').value = '';
  document.getElementById('descricao').value = '';
}


function copiarRelatorioPeriodo() {
  const ini = document.getElementById('dataInicio').value;
  const fim = document.getElementById('dataFim').value;

  if (!ini || !fim) {
    alert('Informe o per√≠odo');
    return;
  }

  const perdidosPeriodo = perdidos.filter(p => p.data >= ini && p.data <= fim);
  const achadosPeriodo = achados.filter(a => a.dataAchado >= ini && a.dataAchado <= fim);

  let totalPerdidos = perdidosPeriodo.length;
  let totalAchados = achadosPeriodo.length;

  let valorPerdido = 0;
  let valorAchado = 0;

  perdidosPeriodo.forEach(p => valorPerdido += p.valorTotal);
  achadosPeriodo.forEach(a => valorAchado += a.valorTotal);

  let texto = `RELAT√ìRIO POR PER√çODO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n`;
  texto += `üìÖ Per√≠odo: ${ini} at√© ${fim}\n\n`;

  texto += `üî¥ Total de registros perdidos: ${totalPerdidos}\n`;
  texto += `üü¢ Total de registros recuperados: ${totalAchados}\n\n`;

  texto += `üí∏ Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `üí∞ Valor total recuperado (estoque evitado de corte): R$ ${valorAchado.toFixed(2)}\n\n`;

  if (perdidosPeriodo.length) {
    texto += `üì¶ LISTA DE PRODUTOS PERDIDOS:\n`;
    perdidosPeriodo.forEach(p => {
      texto += `- ${p.codigo} | ${p.descricao} | Qtd: ${p.quantidade} | R$ ${p.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  if (achadosPeriodo.length) {
    texto += `üì¶ LISTA DE PRODUTOS RECUPERADOS:\n`;
    achadosPeriodo.forEach(a => {
      texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
    });
    texto += `\n`;
  }

  const hoje = new Date().toLocaleDateString('pt-BR');
  texto += `üìÖ Relat√≥rio gerado em: ${hoje}`;

  navigator.clipboard.writeText(texto);
  alert('Relat√≥rio do per√≠odo copiado! Cole direto no WhatsApp ‚úÖ');
}

async function gerarPDFPeriodo() {

  const inicio = document.getElementById('dataInicio').value;
  const fim = document.getElementById('dataFim').value;

  if (!inicio || !fim) {
    alert('Informe a data inicial e a data final');
    return;
  }

  const dataInicio = new Date(inicio);
  const dataFim = new Date(fim);

  const perdidosPeriodo = perdidos.filter(p => {
    const d = new Date(p.data);
    return d >= dataInicio && d <= dataFim;
  });

  const achadosPeriodo = achados.filter(a => {
    const d = new Date(a.dataAchado);
    return d >= dataInicio && d <= dataFim;
  });

  if (!perdidosPeriodo.length && !achadosPeriodo.length) {
    alert('N√£o h√° dados neste per√≠odo');
    return;
  }

  let qtdPerdida = 0;
  let qtdRecuperada = 0;
  let valorPerdido = 0;
  let valorRecuperado = 0;

  perdidosPeriodo.forEach(p => {
    qtdPerdida += p.quantidade;
    valorPerdido += p.valorTotal;
  });

  achadosPeriodo.forEach(a => {
    qtdRecuperada += a.quantidade;
    valorRecuperado += a.valorTotal;
  });

  const percQtd = qtdPerdida > 0 ? (qtdRecuperada / qtdPerdida) * 100 : 0;
  const percValor = valorPerdido > 0 ? (valorRecuperado / valorPerdido) * 100 : 0;

  /* ===== TEXTO DO RELAT√ìRIO ===== */

  let texto = `RELAT√ìRIO ‚Äì PRODUTOS PERDIDOS E ACHADOS\n\n`;
  texto += `Per√≠odo: ${inicio} at√© ${fim}\n\n`;

  texto += `Total de registros perdidos: ${perdidosPeriodo.length}\n`;
  texto += `Total de registros recuperados: ${achadosPeriodo.length}\n\n`;

  texto += `Quantidade perdida: ${qtdPerdida}\n`;
  texto += `Quantidade recuperada: ${qtdRecuperada}\n\n`;

  texto += `Valor total perdido: R$ ${valorPerdido.toFixed(2)}\n`;
  texto += `Valor recuperado (estoque evitado de corte): R$ ${valorRecuperado.toFixed(2)}\n\n`;

  texto += `Percentual de recupera√ß√£o:\n`;
  texto += `- Por quantidade: ${percQtd.toFixed(1)}%\n`;
  texto += `- Por valor: ${percValor.toFixed(1)}%\n\n`;

  texto += `Produtos recuperados:\n`;

  achadosPeriodo.forEach(a => {
    texto += `- ${a.codigo} | ${a.descricao} | Qtd: ${a.quantidade} | R$ ${a.valorTotal.toFixed(2)}\n`;
  });

  texto += `\nRelat√≥rio gerado em: ${new Date().toLocaleDateString()}`;

  /* ===== GERAR PDF ===== */

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Texto no PDF
  const linhas = doc.splitTextToSize(texto, 180);
  doc.text(linhas, 10, 15);

  // Capturar gr√°fico como imagem
  const canvasGrafico = document.getElementById('graficoDias');

  if (canvasGrafico) {
    const imagem = await html2canvas(canvasGrafico);
    const imgData = imagem.toDataURL('image/png');

    doc.addPage();
    doc.text("Gr√°fico ‚Äì Evolu√ß√£o Perdidos x Recuperados", 10, 15);
    doc.addImage(imgData, 'PNG', 10, 25, 180, 90);
  }

  const nomeArquivo = `relatorio_perdidos_achados_${inicio}_a_${fim}.pdf`;
  doc.save(nomeArquivo);
}


carregarDados();
</script>

</body>
</html>

